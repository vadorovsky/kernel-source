From: Murray McAllister <murray.mcallister@insomniasec.com>
Date: Mon Mar 27 11:12:53 2017 +0200
Subject: drm/vmwgfx: NULL pointer dereference in vmw_surface_define_ioctl()
Patch-mainline: Queued in driver maintainer repository
Git-repo: git://people.freedesktop.org/~thomash/linux
Git-commit: 36274ab8c596f1240c606bb514da329add2a1bcd
References: boo#1031052 CVE-2017-7261

Before memory allocations vmw_surface_define_ioctl() checks the
upper-bounds of a user-supplied size, but does not check if the
supplied size is 0.

Add check to avoid NULL pointer dereferences.

Cc: <stable@vger.kernel.org>
Signed-off-by: Murray McAllister <murray.mcallister@insomniasec.com>
Reviewed-by: Sinclair Yeh <syeh@vmware.com>
Signed-off-by: Max Staudt <mstaudt@suse.de>
---
 drivers/gpu/drm/vmwgfx/vmwgfx_resource.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)
diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx_resource.c b/drivers/gpu/drm/vmwgfx/vmwgfx_resource.c
index 5408b1b..c2004d3 100644
--- a/drivers/gpu/drm/vmwgfx/vmwgfx_resource.c
+++ b/drivers/gpu/drm/vmwgfx/vmwgfx_resource.c
@@ -584,8 +584,8 @@ int vmw_surface_define_ioctl(struct drm_device *dev, void *data,
 	for (i = 0; i < DRM_VMW_MAX_SURFACE_FACES; ++i)
 		srf->num_sizes += srf->mip_levels[i];

-	if (srf->num_sizes > DRM_VMW_MAX_SURFACE_FACES *
-	    DRM_VMW_MAX_MIP_LEVELS) {
+	if (srf->num_sizes > DRM_VMW_MAX_SURFACE_FACES * DRM_VMW_MAX_MIP_LEVELS ||
+	    srf->num_sizes == 0) {
 		ret = -EINVAL;
 		goto out_err0;
 	}
