From: Arun Easi <arun.easi@qlogic.com>
Date: Thu, 25 Sep 2014 05:16:51 -0400
Subject: qla2xxx: Unload of qla2xxx driver crashes the machine.
References: bnc#909372,FATE#317544
Patch-Mainline: v3.19
Git-commit: d2749ffadb4c76c04ad82645cc86a2fa39ceff3e

Signed-off-by: Arun Easi <arun.easi@qlogic.com>
Signed-off-by: Saurav Kashyap <saurav.kashyap@qlogic.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Acked-by: Hannes Reinecke <hare@suse.de>
---
 drivers/scsi/qla2xxx/qla_os.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/scsi/qla2xxx/qla_os.c b/drivers/scsi/qla2xxx/qla_os.c
index cbfcbce..bedad09 100644
--- a/drivers/scsi/qla2xxx/qla_os.c
+++ b/drivers/scsi/qla2xxx/qla_os.c
@@ -3222,10 +3222,10 @@ qla2x00_remove_one(struct pci_dev *pdev)
 
 	qla2x00_free_device(base_vha);
 
-	scsi_host_put(base_vha->host);
-
 	qla2x00_clear_drv_active(ha);
 
+	scsi_host_put(base_vha->host);
+
 	qla2x00_unmap_iobases(ha);
 
 	pci_release_selected_regions(ha->pdev, ha->bars);
-- 
1.8.5.2

