From: Bart Van Assche <bart.vanassche@wdc.com>
Date: Wed, 9 Aug 2017 11:32:12 -0700
Subject: dm mpath: do not lock up a CPU with requeuing activity
Patch-mainline: v4.13
Git-commit: 1c23484c355ec360ca2f37914f8a4802c6baeead
References: bsc#1048912

When using the block layer in single queue mode, get_request()
returns ERR_PTR(-EAGAIN) if the queue is dying and the REQ_NOWAIT
flag has been passed to get_request(). Avoid that the kernel
reports soft lockup complaints in this case due to continuous
requeuing activity.

Fixes: 7083abbbf ("dm mpath: avoid that path removal can trigger an infinite loop")
Cc: stable@vger.kernel.org
Signed-off-by: Bart Van Assche <bart.vanassche@wdc.com>
Tested-by: Laurence Oberman <loberman@redhat.com>
Reviewed-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Mike Snitzer <snitzer@redhat.com>
Signed-off-by: Johannes Thumshirn <jthumshirn@suse.de>
---
 drivers/md/dm-mpath.c | 1 -
 1 file changed, 1 deletion(-)

diff --git a/drivers/md/dm-mpath.c b/drivers/md/dm-mpath.c
index 4e00be18c604..6c71316ffa38 100644
--- a/drivers/md/dm-mpath.c
+++ b/drivers/md/dm-mpath.c
@@ -580,7 +580,6 @@ static int __multipath_map(struct dm_target *ti, struct request *clone,
 			if (queue_dying) {
 				atomic_inc(&m->pg_init_in_progress);
 				activate_or_offline_path(pgpath);
-				return DM_MAPIO_REQUEUE;
 			}
 			return DM_MAPIO_DELAY_REQUEUE;
 		}
-- 
2.12.3

