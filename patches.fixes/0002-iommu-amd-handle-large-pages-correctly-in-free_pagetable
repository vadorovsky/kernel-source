From: Joerg Roedel <jroedel@suse.de>
Date: Thu, 18 Jun 2015 10:48:34 +0200
Subject: iommu/amd: Handle large pages correctly in free_pagetable
Git-commit: 0b3fff54bc01e8e6064d222a33e6fa7adabd94cd
Patch-mainline: v4.2-rc1
References: bsc#935866

Make sure that we are skipping over large PTEs while walking
the page-table tree.

Cc: stable@kernel.org
Fixes: 5c34c403b723 ("iommu/amd: Fix memory leak in free_pagetable")
Signed-off-by: Joerg Roedel <jroedel@suse.de>
---
 arch/x86/kernel/amd_iommu.c | 6 ++++++
 1 file changed, 6 insertions(+)

--- a/arch/x86/kernel/amd_iommu.c
+++ b/arch/x86/kernel/amd_iommu.c
@@ -1397,9 +1397,15 @@
 	pt = (u64 *)__pt;					\
 								\
 	for (i = 0; i < 512; ++i) {				\
+		/* PTE present? */				\
 		if (!IOMMU_PTE_PRESENT(pt[i]))			\
 			continue;				\
 								\
+		/* Large PTE? */				\
+		if (PM_PTE_LEVEL(pt[i]) == 0 ||			\
+		    PM_PTE_LEVEL(pt[i]) == 7)			\
+			continue;				\
+								\
 		p = (unsigned long)IOMMU_PTE_PAGE(pt[i]);	\
 		FN(p);						\
 	}							\
