Git-commit: 0ed1dce7520d0e871f3e388b0bd1c2c1be22a8a7
From: NeilBrown <neilb@suse.de>
Date: Tue, 31 Jul 2012 14:33:39 +1000
Subject: [PATCH] nfs: increase number of permitted callback connections.
Patch-mainline: queued for 3.6
References: bnc#771706

By default a sunrpc service is limited to (N+3)*20 connections
where N is the number of threads.  This is 80 when N==1.
If this number is exceeded a warning is printed suggesting that
the number of threads be increased.  However with services which
run a single thread, this is impossible.

For such services there is a ->sv_maxconn setting that can be
used to forcibly increase the limit, and silence the message.
This is used by lockd.

The nfs client uses a sunrpc service to handle callbacks and
it too is single-threaded, so to avoid the useless messages,
and to allow a reasonable number of concurrent connections,
we need to set ->sv_maxconn.  1024 seems like a good number.

Signed-off-by: NeilBrown <neilb@suse.de>

---
 fs/nfs/callback.c |    4 ++++
 1 file changed, 4 insertions(+)

--- linux-3.0-SLE11-SP2.orig/fs/nfs/callback.c
+++ linux-3.0-SLE11-SP2/fs/nfs/callback.c
@@ -264,6 +264,10 @@ int nfs_callback_up(u32 minorversion, st
 		ret = -ENOMEM;
 		goto out_err;
 	}
+	/* As there is only one thread we need to over-ride the
+	 * default maximum of 80 connections
+	 */
+	serv->sv_maxconn = 1024;
 
 	minorversion_setup =  nfs_minorversion_callback_svc_setup(minorversion,
 					serv, xprt, &rqstp, &callback_svc);
