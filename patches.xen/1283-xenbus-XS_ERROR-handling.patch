From http://xenbits.xen.org/hg/linux-2.6.18-xen.hg/rev/afe2ac5137b8
From: xen-devel@lists.xenproject.org
Patch-mainline: n/a
Subject: xenbus: add proper handling of XS_ERROR from Xenbus for transactions

If Xenstore sends back a XS_ERROR for TRANSACTION_END, the driver
wrongly removes the transaction from the transaction list.  For
TRANSACTION_START, it leaks memory.

Check the message as returned from xenbus_dev_request_and_reply(), and
clean up for TRANSACTION_START or discard the error for
TRANSACTION_END.

Signed-off-by: Jennifer Herbert <Jennifer.Herbert@citrix.com>
Signed-off-by: Jan Beulich <jbeulich@suse.com>
Committed-by: Jan Beulich <jbeulich@suse.com>

--- a/drivers/xen/xenbus/xenbus_dev.c
+++ b/drivers/xen/xenbus/xenbus_dev.c
@@ -343,9 +343,13 @@ static ssize_t xenbus_dev_write(struct f
 		}
 
 		if (msg_type == XS_TRANSACTION_START) {
-			trans->handle.id = simple_strtoul(reply, NULL, 0);
-			list_add(&trans->list, &u->transactions);
-		} else if (msg_type == XS_TRANSACTION_END) {
+			if (u->u.msg.type == XS_ERROR)
+				kfree(trans);
+			else {
+				trans->handle.id = simple_strtoul(reply, NULL, 0);
+				list_add(&trans->list, &u->transactions);
+			}
+		} else if (u->u.msg.type == XS_TRANSACTION_END) {
 			list_del(&trans->list);
 			kfree(trans);
 		}
