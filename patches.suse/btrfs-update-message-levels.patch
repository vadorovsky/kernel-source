From: David Sterba <dsterba@suse.cz>
Date: Tue, 06 Mar 2012 00:06:18 +0100
Patch-mainline: pending
References: FATE#306586
Subject: [PATCH] Btrfs: update message levels

Signed-off-by: David Sterba <dsterba@suse.cz>
---
---
 fs/btrfs/compression.c      |    2 +-
 fs/btrfs/disk-io.c          |   20 ++++++++++----------
 fs/btrfs/extent-tree.c      |   24 ++++++++++++++----------
 fs/btrfs/free-space-cache.c |    5 +++--
 fs/btrfs/inode.c            |   10 +++++-----
 fs/btrfs/root-tree.c        |    2 +-
 fs/btrfs/super.c            |   19 ++++++++++++-------
 fs/btrfs/volumes.c          |    8 ++++----
 8 files changed, 50 insertions(+), 40 deletions(-)

--- a/fs/btrfs/compression.c
+++ b/fs/btrfs/compression.c
@@ -411,7 +411,7 @@ int btrfs_submit_compressed_write(struct
 			bio_add_page(bio, page, PAGE_CACHE_SIZE, 0);
 		}
 		if (bytes_left < PAGE_CACHE_SIZE) {
-			printk("bytes left %lu compress len %lu nr %lu\n",
+			printk(KERN_DEBUG "bytes left %lu compress len %lu nr %lu\n",
 			       bytes_left, cb->compressed_len, cb->nr_pages);
 		}
 		bytes_left -= PAGE_CACHE_SIZE;
--- a/fs/btrfs/disk-io.c
+++ b/fs/btrfs/disk-io.c
@@ -292,7 +292,7 @@ static int csum_tree_block(struct btrfs_
 			memcpy(&found, result, csum_size);
 
 			read_extent_buffer(buf, &val, 0, csum_size);
-			printk_ratelimited(KERN_INFO "btrfs: %s checksum verify "
+			printk_ratelimited(KERN_WARNING "btrfs: %s checksum verify "
 				       "failed on %llu wanted %X found %X "
 				       "level %d\n",
 				       root->fs_info->sb->s_id,
@@ -336,7 +336,7 @@ static int verify_parent_transid(struct
 		ret = 0;
 		goto out;
 	}
-	printk_ratelimited("parent transid verify failed on %llu wanted %llu "
+	printk_ratelimited(KERN_WARNING "btrfs: parent transid verify failed on %llu wanted %llu "
 		       "found %llu\n",
 		       (unsigned long long)eb->start,
 		       (unsigned long long)parent_transid,
@@ -599,7 +599,7 @@ static int btree_readpage_end_io_hook(st
 
 	found_start = btrfs_header_bytenr(eb);
 	if (found_start != eb->start) {
-		printk_ratelimited(KERN_INFO "btrfs bad tree block start "
+		printk_ratelimited(KERN_WARNING "btrfs bad tree block start "
 			       "%llu %llu\n",
 			       (unsigned long long)found_start,
 			       (unsigned long long)eb->start);
@@ -607,7 +607,7 @@ static int btree_readpage_end_io_hook(st
 		goto err;
 	}
 	if (check_tree_block_fsid(root, eb)) {
-		printk_ratelimited(KERN_INFO "btrfs bad fsid on block %llu\n",
+		printk_ratelimited(KERN_WARNING "btrfs bad fsid on block %llu\n",
 			       (unsigned long long)eb->start);
 		ret = -EIO;
 		goto err;
@@ -2391,13 +2391,13 @@ retry_root_backup:
 
 	ret = btrfs_init_space_info(fs_info);
 	if (ret) {
-		printk(KERN_ERR "Failed to initial space info: %d\n", ret);
+		printk(KERN_ERR "btrfs: Failed to initial space info: %d\n", ret);
 		goto fail_block_groups;
 	}
 
 	ret = btrfs_read_block_groups(extent_root);
 	if (ret) {
-		printk(KERN_ERR "Failed to read block groups: %d\n", ret);
+		printk(KERN_ERR "btrfs: Failed to read block groups: %d\n", ret);
 		goto fail_block_groups;
 	}
 
@@ -2616,7 +2616,7 @@ static void btrfs_end_buffer_write_sync(
 	if (uptodate) {
 		set_buffer_uptodate(bh);
 	} else {
-		printk_ratelimited(KERN_WARNING "lost page write due to "
+		printk_ratelimited(KERN_WARNING "btrfs: lost page write due to "
 					"I/O error on %s\n",
 				       bdevname(bh->b_bdev, b));
 		/* note, we dont' set_buffer_write_io_error because we have
@@ -2789,7 +2789,7 @@ static int write_dev_flush(struct btrfs_
 		wait_for_completion(&device->flush_wait);
 
 		if (bio_flagged(bio, BIO_EOPNOTSUPP)) {
-			printk("btrfs: disabling barriers on dev %s\n",
+			printk(KERN_INFO "btrfs: disabling barriers on dev %s\n",
 			       device->name);
 			device->nobarriers = 1;
 		}
@@ -3435,7 +3435,7 @@ static int btrfs_check_super_valid(struc
 		return 0;
 
 	if (fs_info->fs_state & BTRFS_SUPER_FLAG_ERROR) {
-		printk(KERN_WARNING "warning: mount fs with errors, "
+		printk(KERN_WARNING "btrfs: warning: mount fs with errors, "
 		       "running btrfsck is recommended\n");
 	}
 
@@ -3532,7 +3532,7 @@ int btrfs_destroy_delayed_refs(struct bt
 	spin_lock(&delayed_refs->lock);
 	if (delayed_refs->num_entries == 0) {
 		spin_unlock(&delayed_refs->lock);
-		printk(KERN_INFO "delayed_refs has NO entry\n");
+		printk(KERN_DEBUG "btrfs: delayed_refs has NO entry\n");
 		return ret;
 	}
 
--- a/fs/btrfs/extent-tree.c
+++ b/fs/btrfs/extent-tree.c
@@ -2300,7 +2300,9 @@ static noinline int run_clustered_refs(s
 				kfree(extent_op);
 
 				if (ret) {
-					printk(KERN_DEBUG "run_delayed_extent_op returned %d\n", ret);
+					printk(KERN_DEBUG
+						"btrfs: run_delayed_extent_op returned %d\n",
+						ret);
 					spin_lock(&delayed_refs->lock);
 					btrfs_delayed_ref_unlock(trans,
 								 locked_ref);
@@ -2344,7 +2346,9 @@ static noinline int run_clustered_refs(s
 		btrfs_put_delayed_ref(ref);
 
 		if (ret) {
-			printk(KERN_DEBUG "run_one_delayed_ref returned %d\n", ret);
+			printk(KERN_DEBUG
+				"btrfs: run_one_delayed_ref returned %d\n",
+				ret);
 			spin_lock(&delayed_refs->lock);
 			return ret;
 		}
@@ -3479,7 +3483,7 @@ static void check_system_chunk(struct bt
 
 	thresh = get_system_chunk_thresh(root, type);
 	if (left < thresh && btrfs_test_opt(root, ENOSPC_DEBUG)) {
-		printk(KERN_INFO "left=%llu, need=%llu, flags=%llu\n",
+		printk(KERN_INFO "btrfs: left=%llu, need=%llu, flags=%llu\n",
 		       left, thresh, type);
 		dump_space_info(info, 0, 0);
 	}
@@ -3806,7 +3810,8 @@ again:
 		ret = wait_event_killable(space_info->wait, !space_info->flush);
 		/* Must have been interrupted, return */
 		if (ret) {
-			printk(KERN_DEBUG "%s returning -EINTR\n", __func__);
+			printk(KERN_DEBUG "btrfs: %s returning -EINTR\n",
+					__func__);
 			return -EINTR;
 		}
 
@@ -5487,7 +5492,7 @@ static noinline int find_free_extent(str
 
 	space_info = __find_space_info(root->fs_info, data);
 	if (!space_info) {
-		printk(KERN_ERR "No space info for %llu\n", data);
+		printk(KERN_ERR "btrfs: No space info for %llu\n", data);
 		return -ENOSPC;
 	}
 
@@ -5959,7 +5964,7 @@ static int __btrfs_free_reserved_extent(
 
 	cache = btrfs_lookup_block_group(root->fs_info, start);
 	if (!cache) {
-		printk(KERN_ERR "Unable to find block group for %llu\n",
+		printk(KERN_ERR "btrfs: Unable to find block group for %llu\n",
 		       (unsigned long long)start);
 		return -ENOSPC;
 	}
@@ -6274,11 +6279,10 @@ use_block_rsv(struct btrfs_trans_handle
 		return block_rsv;
 	if (ret) {
 		static DEFINE_RATELIMIT_STATE(_rs,
-				DEFAULT_RATELIMIT_INTERVAL,
-				/*DEFAULT_RATELIMIT_BURST*/ 2);
+				DEFAULT_RATELIMIT_INTERVAL * 10,
+				/*DEFAULT_RATELIMIT_BURST*/ 1);
 		if (__ratelimit(&_rs)) {
-			printk(KERN_DEBUG "btrfs: block rsv returned %d\n", ret);
-			WARN_ON(1);
+			WARN(1, KERN_DEBUG "btrfs: block rsv returned %d\n", ret);
 		}
 		ret = reserve_metadata_bytes(root, block_rsv, blocksize, 0);
 		if (!ret) {
--- a/fs/btrfs/free-space-cache.c
+++ b/fs/btrfs/free-space-cache.c
@@ -101,7 +101,8 @@ struct inode *lookup_free_space_inode(st
 
 	spin_lock(&block_group->lock);
 	if (!((BTRFS_I(inode)->flags & flags) == flags)) {
-		printk(KERN_INFO "Old style space inode found, converting.\n");
+		printk(KERN_INFO
+			"btrfs: Old style space inode found, converting.\n");
 		BTRFS_I(inode)->flags |= BTRFS_INODE_NODATASUM |
 			BTRFS_INODE_NODATACOW;
 		block_group->disk_cache_state = BTRFS_DC_CLEAR;
@@ -792,7 +793,7 @@ int load_free_space_cache(struct btrfs_f
 
 	if (!matched) {
 		__btrfs_remove_free_space_cache(ctl);
-		printk(KERN_ERR "block group %llu has an wrong amount of free "
+		printk(KERN_ERR "btrfs: block group %llu has an wrong amount of free "
 		       "space\n", block_group->key.objectid);
 		ret = -1;
 	}
--- a/fs/btrfs/inode.c
+++ b/fs/btrfs/inode.c
@@ -2057,7 +2057,7 @@ good:
 	return 0;
 
 zeroit:
-	printk_ratelimited(KERN_INFO "btrfs csum failed ino %llu off %llu csum %u "
+	printk_ratelimited(KERN_WARNING "btrfs csum failed ino %llu off %llu csum %u "
 		       "private %llu\n",
 		       (unsigned long long)btrfs_ino(page->mapping->host),
 		       (unsigned long long)start, csum,
@@ -2455,13 +2455,13 @@ int btrfs_orphan_cleanup(struct btrfs_ro
 	}
 
 	if (nr_unlink)
-		printk(KERN_INFO "btrfs: unlinked %d orphans\n", nr_unlink);
+		pr_debug("btrfs: unlinked %d orphans\n", nr_unlink);
 	if (nr_truncate)
-		printk(KERN_INFO "btrfs: truncated %d orphans\n", nr_truncate);
+		pr_debug("btrfs: truncated %d orphans\n", nr_truncate);
 
 out:
 	if (ret)
-		printk(KERN_CRIT "btrfs: could not do orphan cleanup %d\n", ret);
+		printk(KERN_ERR "btrfs: could not do orphan cleanup %d\n", ret);
 	btrfs_free_path(path);
 	return ret;
 }
@@ -3821,7 +3821,7 @@ void btrfs_evict_inode(struct inode *ino
 			ret = btrfs_block_rsv_migrate(global_rsv, rsv, min_size);
 
 		if (ret) {
-			printk(KERN_WARNING "Could not get space for a "
+			printk(KERN_INFO "btrfs: Could not get space for a "
 			       "delete, will truncate on mount %d\n", ret);
 			btrfs_orphan_del(NULL, inode);
 			btrfs_free_block_rsv(root, rsv);
--- a/fs/btrfs/root-tree.c
+++ b/fs/btrfs/root-tree.c
@@ -104,7 +104,7 @@ int btrfs_update_root(struct btrfs_trans
 
 	if (ret != 0) {
 		btrfs_print_leaf(root, path->nodes[0]);
-		printk(KERN_CRIT "unable to update root key %llu %u %llu\n",
+		printk(KERN_CRIT "btrfs: unable to update root key %llu %u %llu\n",
 		       (unsigned long long)key->objectid, key->type,
 		       (unsigned long long)key->offset);
 		BUG_ON(1);
--- a/fs/btrfs/super.c
+++ b/fs/btrfs/super.c
@@ -519,11 +519,11 @@ int btrfs_parse_options(struct btrfs_roo
 			btrfs_set_opt(info->mount_opt, ENOSPC_DEBUG);
 			break;
 		case Opt_defrag:
-			printk(KERN_INFO "btrfs: enabling auto defrag");
+			printk(KERN_INFO "btrfs: enabling auto defrag\n");
 			btrfs_set_opt(info->mount_opt, AUTO_DEFRAG);
 			break;
 		case Opt_recovery:
-			printk(KERN_INFO "btrfs: enabling auto recovery");
+			printk(KERN_INFO "btrfs: enabling auto recovery\n");
 			btrfs_set_opt(info->mount_opt, RECOVERY);
 			break;
 		case Opt_fatal_errors:
@@ -781,7 +781,7 @@ static int btrfs_fill_super(struct super
 
 	err = open_ctree(sb, fs_devices, (char *)data);
 	if (err) {
-		printk("btrfs: open_ctree failed\n");
+		printk(KERN_ERR "btrfs: open_ctree failed\n");
 		return err;
 	}
 
@@ -1490,9 +1490,14 @@ static void btrfs_fs_dirty_inode(struct
 	int ret;
 
 	ret = btrfs_dirty_inode(inode);
-	if (ret)
-		printk_ratelimited(KERN_ERR "btrfs: fail to dirty inode %Lu "
-				   "error %d\n", btrfs_ino(inode), ret);
+	if (ret) {
+		static DEFINE_RATELIMIT_STATE(_rs,
+				DEFAULT_RATELIMIT_INTERVAL,
+				DEFAULT_RATELIMIT_BURST);
+		if (__ratelimit(&_rs))
+			pr_debug("btrfs: fail to dirty inode %llu error %d\n",
+				(unsigned long long)btrfs_ino(inode), ret);
+	}
 }
 
 static dev_t btrfs_get_maps_dev(struct inode *inode)
@@ -1541,7 +1546,7 @@ static int btrfs_interface_init(void)
 static void btrfs_interface_exit(void)
 {
 	if (misc_deregister(&btrfs_misc) < 0)
-		printk(KERN_INFO "misc_deregister failed for control device");
+		printk(KERN_INFO "btrfs: misc_deregister failed for control device\n");
 }
 
 static int __init init_btrfs_fs(void)
--- a/fs/btrfs/volumes.c
+++ b/fs/btrfs/volumes.c
@@ -619,7 +619,7 @@ static int __btrfs_open_devices(struct b
 
 		bdev = blkdev_get_by_path(device->name, flags, holder);
 		if (IS_ERR(bdev)) {
-			printk(KERN_INFO "open %s failed\n", device->name);
+			printk(KERN_INFO "btrfs: open %s failed\n", device->name);
 			goto error;
 		}
 		filemap_write_and_wait(bdev->bd_inode->i_mapping);
@@ -3786,7 +3786,7 @@ static int __btrfs_map_block(struct btrf
 	read_unlock(&em_tree->lock);
 
 	if (!em) {
-		printk(KERN_CRIT "unable to find logical %llu len %llu\n",
+		printk(KERN_CRIT "btrfs: unable to find logical %llu len %llu\n",
 		       (unsigned long long)logical,
 		       (unsigned long long)*length);
 		BUG();
@@ -4196,7 +4196,7 @@ int btrfs_map_bio(struct btrfs_root *roo
 
 	total_devs = bbio->num_stripes;
 	if (map_length < length) {
-		printk(KERN_CRIT "mapping failed logical %llu bio len %llu "
+		printk(KERN_CRIT "btrfs: mapping failed logical %llu bio len %llu "
 		       "len %llu\n", (unsigned long long)logical,
 		       (unsigned long long)length,
 		       (unsigned long long)map_length);
@@ -4468,7 +4468,7 @@ static int read_one_dev(struct btrfs_roo
 			return -EIO;
 
 		if (!device) {
-			printk(KERN_WARNING "warning devid %llu missing\n",
+			printk(KERN_WARNING "btrfs: warning devid %llu missing\n",
 			       (unsigned long long)devid);
 			device = add_missing_dev(root, devid, dev_uuid);
 			if (!device)
