From: Borislav Petkov <bp@suse.de>
Date: Sun, 17 Dec 2017 16:45:58 +0100
Subject: x86/spec: Add "nospec" chicken bit
Patch-mainline: submitted on 2018/1/9
References: bsc#1068032

... which disables the speculation features toggle and avoids the
performance overhead from them.

Carved out from a patch by Tim Chen <tim.c.chen@linux.intel.com>

Signed-off-by: Borislav Petkov <bp@suse.de>
---
 Documentation/kernel-parameters.txt |    5 +++++
 arch/x86/kernel/cpu/spec_ctrl.c     |   10 ++++++++++
 2 files changed, 15 insertions(+)

--- a/arch/x86/kernel/cpu/spec_ctrl.c
+++ b/arch/x86/kernel/cpu/spec_ctrl.c
@@ -55,3 +55,13 @@ void x86_spec_check(void)
 	}
 }
 EXPORT_SYMBOL_GPL(x86_spec_check);
+
+static int __init nospec(char *str)
+{
+	setup_clear_cpu_cap(X86_FEATURE_SPEC_CTRL);
+	ibrs_state = 0;
+	ibpb_state = 0;
+
+	return 0;
+}
+early_param("nospec", nospec);
--- a/Documentation/kernel-parameters.txt
+++ b/Documentation/kernel-parameters.txt
@@ -1757,6 +1757,11 @@ bytes respectively. Such letter suffixes
 			Disable SMEP (Supervisor Mode Execution Protection)
 			even if it is supported by processor.
 
+	nospec		[X86]
+			Disable indirect branch restricted speculation and
+			indirect branch prediction barrier to avoid performance
+			penalties in trusted environments.
+
 	noexec32	[X86-64]
 			This affects only 32-bit executables.
 			noexec32=on: enable non-executable mappings (default)
