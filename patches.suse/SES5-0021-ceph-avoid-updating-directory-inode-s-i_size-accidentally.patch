From: "Yan, Zheng" <zyan@redhat.com>
Date: Fri, 26 Feb 2016 17:16:32 +0800
Subject: ceph: avoid updating directory inode's i_size accidentally
Git-commit: a3d714c33632ef6bfdfaacc74ae6ba297b4c5820
Patch-mainline: v4.6-rc1
References: FATE#322288

Directory inode's i_size is used by readdir cache.

Signed-off-by: Yan, Zheng <zyan@redhat.com>
Acked-by: Luis Henriques <lhenriques@suse.com>
---
 fs/ceph/inode.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/fs/ceph/inode.c
+++ b/fs/ceph/inode.c
@@ -554,6 +554,10 @@ int ceph_fill_file_size(struct inode *in
 	if (ceph_seq_cmp(truncate_seq, ci->i_truncate_seq) > 0 ||
 	    (truncate_seq == ci->i_truncate_seq && size > inode->i_size)) {
 		dout("size %lld -> %llu\n", inode->i_size, size);
+		if (size > 0 && S_ISDIR(inode->i_mode)) {
+			pr_err("fill_file_size non-zero size for directory\n");
+			size = 0;
+		}
 		i_size_write(inode, size);
 		inode->i_blocks = calc_inode_blocks(size);
 		ci->i_reported_size = size;
